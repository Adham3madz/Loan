<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</title>
    <style>
        /* Modern Font */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            /* CHANGED: From Purple to Dark Slate/Navy Gradient */
            background: linear-gradient(135deg, #141E30 0%, #243B55 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            color: #fff;
        }

        /* Glassmorphism Container */
        .glass-container {
            background: rgba(255, 255, 255, 0.1); /* Slightly more transparent for dark theme */
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); /* Darker shadow */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            width: 100%;
            max-width: 1000px;
            margin-top: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* --- SEARCH BAR STYLES (NEW) --- */
        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .search-input, .status-filter {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            outline: none;
        }

        .search-input {
            flex: 2; /* Takes more space */
        }
        
        .search-input::placeholder { color: rgba(255, 255, 255, 0.6); }

        .status-filter {
            flex: 1;
            cursor: pointer;
        }
        
        .status-filter option {
            /* CHANGED: Dark background for dropdown options */
            background: #243B55; 
            color: white;
        }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .card h3 {
            margin: 0;
            font-size: 1rem;
            color: #b0bec5;
            font-weight: normal;
        }

        .card p {
            margin: 10px 0 0 0;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .card-collected p { color: #2ecc71; text-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
        .card-pending p { color: #3498db; text-shadow: 0 0 10px rgba(52, 152, 219, 0.3); }
        .card-late { border-color: rgba(231, 76, 60, 0.5); background: rgba(231, 76, 60, 0.1); }
        .card-late p { color: #e74c3c; text-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }

        /* Animation for Late Rows */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .row-late {
            background: rgba(231, 76, 60, 0.15) !important;
            border: 1px solid rgba(231, 76, 60, 0.5);
            animation: pulse-red 2s infinite;
        }
        .row-late td { color: #ffdad6; }

        .action-bar {
            margin-bottom: 20px;
            text-align: left;
        }

        .btn-export {
            background: #2ecc71;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-export:hover { background: #27ae60; transform: scale(1.05); }

        .btn-pay {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            transition: 0.3s;
            font-size: 0.9em;
        }
        .btn-pay:hover {
            background: #2ecc71; border-color: #2ecc71; transform: scale(1.1); box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        th { background: rgba(0, 0, 0, 0.3); font-weight: bold; color: #eceff1; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(255, 255, 255, 0.05); }

        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.9em; font-weight: bold; }
        .status-paid { background: rgba(46, 204, 113, 0.3); color: #d4edda; }
        .status-late { background: rgba(231, 76, 60, 0.3); color: #f8d7da; }
        .status-soon { background: rgba(241, 196, 15, 0.3); color: #fff3cd; }

        /* --- MOBILE RESPONSIVE DESIGN --- */
        @media screen and (max-width: 768px) {
            body { padding: 10px; align-items: flex-start; }
            .glass-container { padding: 15px; margin-top: 10px; }
            h1 { font-size: 1.5rem; }
            
            /* Stack search bar on phone */
            .search-container { flex-direction: column; gap: 10px; }
            
            .dashboard { grid-template-columns: 1fr; gap: 15px; }
            
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            
            tr {
                margin-bottom: 20px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 15px;
                padding: 10px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            
            td {
                border: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                position: relative;
                padding-left: 0;
                padding-right: 50%;
                text-align: left;
                display: flex;
                justify-content: space-between;
                align-items: center;
                min-height: 35px;
            }
            td:last-child { border-bottom: none; justify-content: center; padding-top: 15px; }
            td::before {
                content: attr(data-label);
                font-weight: bold;
                color: #ddd;
                text-align: right;
                flex: 1;
                margin-left: 10px;
            }
            .btn-pay { width: 100%; padding: 10px; font-size: 1rem; }
            .action-bar { display: flex; flex-direction: column; gap: 10px; }
            .btn-export { text-align: center; margin-left: 0 !important; }
        }
    </style>
</head>
<body>

    <div class="glass-container">
        <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h1>

        <div class="dashboard">
            <div class="card">
                <h3>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„</h3>
                <p class="card-collected">{{ "{:,.0f}".format(summary.Collected) }} EGP</p>
            </div>
            <div class="card">
                <h3>ğŸ“‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3>
                <p class="card-pending">{{ "{:,.0f}".format(summary.Pending) }} EGP</p>
            </div>
            <div class="card card-late">
                <h3>ğŸš¨ Ù…ØªØ£Ø®Ø±Ø§Øª ÙˆØ§Ø¬Ø¨Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯</h3>
                <p>{{ "{:,.0f}".format(summary.Late) }} EGP</p>
            </div>
        </div>
        
        <div class="action-bar">
            <a href="/add" class="btn-export" style="background:#3498db; margin-left:10px;">â• Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</a>
            <a href="/export" class="btn-export">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Excel</a>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„ØµÙ†Ù..." onkeyup="filterTable()">
            <select id="statusFilter" class="status-filter" onchange="filterTable()">
                <option value="all">ğŸ“Œ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="Ù…ØªØ£Ø®Ø±">ğŸš¨ Ù…ØªØ£Ø®Ø±</option>
                <option value="Ù…Ø³ØªØ­Ù‚">â³ Ù…Ø³ØªØ­Ù‚</option>
                <option value="Ù…Ø³Ø¯Ø¯">âœ… Ù…Ø³Ø¯Ø¯</option>
            </select>
        </div>

        <table id="installmentsTable">
            <thead>
                <tr>
                    <th>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>ğŸ“¦ Ø§Ù„ØµÙ†Ù</th>
                    <th>ğŸ“… Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                    <th>ğŸ’° Ø§Ù„Ù‚Ø³Ø·</th>
                    <th>ğŸ“‰ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                    <th>ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>âš¡ Ø¥Ø¬Ø±Ø§Ø¡</th> 
                </tr>
            </thead>
            <tbody>
                {% for row in installments %}
                <tr class="{% if 'Ù…ØªØ£Ø®Ø±' in row.Status %}row-late{% endif %}">
                    <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„" class="searchable">{{ row.FullName }}</td>
                    <td data-label="Ø§Ù„ØµÙ†Ù" class="searchable">{{ row.ItemDescription }}</td>
                    <td data-label="Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚">{{ row.DueDate }}</td>
                    <td data-label="Ø§Ù„Ù‚Ø³Ø·">{{ "{:,.2f}".format(row.InstallmentAmount) }}</td>
                    <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ">{{ "{:,.2f}".format(row.RemainingAmount) }}</td>
                    <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                        {% if 'Ù…Ø³Ø¯Ø¯' in row.Status %}
                            <span class="badge status-paid">âœ… {{ row.Status }}</span>
                        {% elif 'Ù…ØªØ£Ø®Ø±' in row.Status %}
                            <span class="badge status-late">ğŸš¨ {{ row.Status }}</span>
                        {% else %}
                            <span class="badge status-soon">â³ {{ row.Status }}</span>
                        {% endif %}
                    </td>
                    <td data-label="Ø¥Ø¬Ø±Ø§Ø¡">
                        {% if row.RemainingAmount > 0 %}
                        <form action="{{ url_for('pay_installment', id=row.InstallmentID) }}" method="post" onsubmit="return confirm('Ù‡Ù„ ØªØ¤ÙƒØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ø·ØŸ ğŸ’¸');">
                            <button type="submit" class="btn-pay">ğŸ’¸ Ø³Ø¯Ø§Ø¯</button>
                        </form>
                        {% else %}
                        <span>ğŸ”’ ØªÙ…</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        function filterTable() {
            // Get input values
            var searchInput = document.getElementById("searchInput").value.toLowerCase();
            var statusFilter = document.getElementById("statusFilter").value;
            
            // Get table rows
            var table = document.getElementById("installmentsTable");
            var tr = table.getElementsByTagName("tr");

            // Loop through all table rows (start from 1 to skip header)
            for (var i = 1; i < tr.length; i++) {
                var row = tr[i];
                var showRow = true;

                // 1. Text Search Logic (Check Customer Name OR Item)
                var customerName = row.getElementsByTagName("td")[0].textContent.toLowerCase();
                var itemName = row.getElementsByTagName("td")[1].textContent.toLowerCase();
                
                if (customerName.indexOf(searchInput) === -1 && itemName.indexOf(searchInput) === -1) {
                    showRow = false;
                }

                // 2. Status Dropdown Logic
                if (statusFilter !== "all") {
                    var statusText = row.getElementsByTagName("td")[5].textContent; // Status column
                    if (statusText.indexOf(statusFilter) === -1) {
                        showRow = false;
                    }
                }

                // Apply Visibility
                if (showRow) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            }
        }
    </script>

</body>
</html>